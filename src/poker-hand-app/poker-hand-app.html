<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/lib/elements/dom-repeat.html">

<link rel="import" href="../../bower_components/voice-elements/dist/voice-player.html">
<link rel="import" href="../../bower_components/game-card/game-card.html">
<link rel="import" href="../../bower_components/random-list/random-list.html">

<dom-module id="poker-hand-app">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <voice-player id="voicePlayer" accent="fr-FR"></voice-player>
    <random-list id="randomCards"></random-list>

    <h1>Main au Poker</h1>

    <h2>Main Mystère</h2>
    <template is="dom-repeat" items="[[secretHand]]">
      <game-card
        symbol="[[item.symbol]]" rank="[[item.rank]]" unrevealed flippable
        description="[[item.description]]"
        on-click="revealCard"></game-card>
    </template>

    <h2>Votre Main</h2>
    <template is="dom-repeat" items="[[revealedHand]]">
      <game-card symbol="[[item.symbol]]" rank="[[item.rank]]"></game-card>
    </template>

    <h2>Devinez les cartes de la Main Mystère</h2>
    <template is="dom-repeat" items="[[allCards]]">
      <game-card symbol="[[item.symbol]]" rank="[[item.rank]]" flippable
        description="[[item.description]]"
        on-click="revealCard"></game-card>
    </template>
  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class PokerHandApp extends Polymer.Element {
      static get is() { return 'poker-hand-app'; }
      static get properties() {
        return {
          secretHand: {
            type: Array,
          },
          revealedHand: {
            type: Array,
          },
          allCards: {
            type: Array,
          },
        };
      }

      revealCard(e) {
        this.$.voicePlayer.speech.text = e.currentTarget.description;
        this.$.voicePlayer.speak();
      }

      ready() {
        super.ready();

        const symbols = [ '♦', '♣', '♥', '♠' ];
        const symbolNames = [ 'Carreau', 'Trèfle', 'Coeur', 'Pique' ];
        const ranks = [ 'a', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'j', 'q', 'k' ];
        const rankNames = [ 'As', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'Valet', 'Dame', 'Roi' ];

        const getSuite = (symbol, symbolName) => {
          let rankIndex = 0;
          return new Array(13).fill({}).map(element => {
            const card = {
              symbol,
              rank: ranks[rankIndex],
              description: `${rankNames[rankIndex]} de ${symbolName}`,
            };
            rankIndex = rankIndex + 1;
            return card;
          });
        };

        const diamonds = getSuite(symbols[0], symbolNames[0]);
        const clubs = getSuite(symbols[1], symbolNames[1]);
        const hearts = getSuite(symbols[2], symbolNames[2]);
        const spades = getSuite(symbols[3], symbolNames[3]);

        const allCards = diamonds.concat(clubs).concat(hearts).concat(spades);

        const secretHand = this.$.randomCards.pickRandomList({
          source: allCards,
          max: 5,
        });

        const revealedHand = this.$.randomCards.pickRandomList({
          source: secretHand.rest,
          max: 5,
        });

        // Update UI.
        this.secretHand = secretHand.list.map(card => JSON.parse(card));
        this.revealedHand = revealedHand.list.map(card => JSON.parse(card));
        this.allCards = allCards;
      }
    }

    window.customElements.define(PokerHandApp.is, PokerHandApp);
  </script>
</dom-module>
